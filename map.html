<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>苏运新航·运河文化调研地图</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- 聚合插件 -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }

    .info-title { font-weight: bold; margin-bottom: 5px; color: #2c3e50; }
    .popup-img {
      width: 220px; height: 130px; object-fit: cover;
      margin-top: 8px; border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }

    .fa-marker{
      width: 34px; height: 34px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 16px; font-weight: 700;
      border: 2px solid #ffffff; box-shadow: 0 2px 8px rgba(0,0,0,.25);
    }

    .legend, .fit-btn, .filter-box, .edit-box {
      background: #fff; padding: 8px 12px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15); font-size: 14px;
    }
    .legend .row{ display:flex; align-items:center; margin:4px 0; gap:8px; }
    .legend .dot{
      width: 16px; height: 16px; border-radius: 50%;
      display:inline-block; border:1.5px solid #fff; box-shadow: 0 1px 4px rgba(0,0,0,.2);
    }

    .fit-btn, .edit-box { cursor: pointer; }
    .fit-btn:hover, .filter-box:hover, .edit-box:hover{ background:#f6f8fa; }

    .filter-box select{ border:none; outline:none; font-size:14px; background:transparent; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // ============== 初始化 ==============
    const map = L.map('map').setView([32.9, 119.6], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap 贡献者'
    }).addTo(map);

    // ============== 图标样式 ==============
    const typeStyles = {
      museum:  { color: '#3B82F6', iconClass: 'fa-landmark', label:'博物馆/展馆' },
      bridge:  { color: '#F59E0B', iconClass: 'fa-bridge',   label:'桥梁' },
      landmark:{ color: '#10B981', iconClass: 'fa-location-dot', label:'街区/河段/塔楼' }
    };
    function iconFor(type){
      const t = typeStyles[type] || typeStyles.landmark;
      return L.divIcon({
        html: `<div class="fa-marker" style="background:${t.color}">
                 <i class="fa-solid ${t.iconClass}"></i>
               </div>`,
        className: '',
        iconSize: [34,34], iconAnchor: [17,17], popupAnchor:[0,-10]
      });
    }

    // ============== 数据点 ==============
    const places = [
      { name:"清江闸遗址", city:"淮安", type:"landmark", coords:[33.6119,119.0219], desc:"明永乐年间始建。", img:"https://via.placeholder.com/220x130?text=清江闸" },
      { name:"中国漕运博物馆", city:"淮安", type:"museum", coords:[33.6186,119.0236], desc:"全国唯一漕运专题博物馆。", img:"https://via.placeholder.com/220x130?text=漕运博物馆" },
      { name:"中国大运河博物馆", city:"扬州", type:"museum", coords:[32.3676,119.4447], desc:"国家一级博物馆。", img:"https://via.placeholder.com/220x130?text=运河博物馆" },
      { name:"邵伯船闸", city:"扬州", type:"landmark", coords:[32.5508,119.3232], desc:"大运河上的重要船闸。", img:"https://via.placeholder.com/220x130?text=邵伯船闸" },
      { name:"今月桥", city:"扬州", type:"bridge", coords:[32.3669,119.4452], desc:"广场地标性桥梁。", img:"https://via.placeholder.com/220x130?text=今月桥" },
      { name:"大运塔", city:"扬州", type:"landmark", coords:[32.3689,119.4467], desc:"三湾地标塔。", img:"https://via.placeholder.com/220x130?text=大运塔" },
      { name:"文峰塔", city:"扬州", type:"landmark", coords:[32.3927,119.4498], desc:"扬州古塔名胜。", img:"https://via.placeholder.com/220x130?text=文峰塔" },
      { name:"天中塔", city:"扬州", type:"landmark", coords:[32.3889,119.4519], desc:"古运河畔塔楼。", img:"https://via.placeholder.com/220x130?text=天中塔" },
      { name:"淮扬商街", city:"扬州", type:"landmark", coords:[32.3661,119.4441], desc:"复原市井生活的展馆。", img:"https://via.placeholder.com/220x130?text=淮扬商街" },
      { name:"盐商住宅", city:"扬州", type:"landmark", coords:[32.3664,119.4436], desc:"盐商典型宅邸。", img:"https://via.placeholder.com/220x130?text=盐商住宅" },
      { name:"青果巷历史文化街区", city:"常州", type:"landmark", coords:[31.8099,119.9748], desc:"江南名士第一巷。", img:"https://via.placeholder.com/220x130?text=青果巷" },
      { name:"文亨桥", city:"常州", type:"bridge", coords:[31.8124,119.9727], desc:"三孔拱桥。", img:"https://via.placeholder.com/220x130?text=文亨桥" },
      { name:"新坊桥", city:"常州", type:"bridge", coords:[31.8129,119.9740], desc:"古桥之一。", img:"https://via.placeholder.com/220x130?text=新坊桥" },
      { name:"石龙嘴", city:"常州", type:"landmark", coords:[31.8166,119.9694], desc:"古桥云集的文化地标。", img:"https://via.placeholder.com/220x130?text=石龙嘴" },
      { name:"南市河段", city:"常州", type:"landmark", coords:[31.8179,119.9712], desc:"承载千年文脉的河段。", img:"https://via.placeholder.com/220x130?text=南市河段" }
    ];

    // ============== 标注与聚合 ==============
    let markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);

    function renderMarkers(city="全部", type="全部"){
      markerCluster.clearLayers();
      const filtered = places.filter(p=>{
        return (city==="全部"||p.city===city) && (type==="全部"||p.type===type);
      });

      const bounds = [];
      filtered.forEach(p=>{
        const mk = L.marker(p.coords, {icon:iconFor(p.type)})
          .bindPopup(`
            <div class="info-title">${p.name}</div>
            <b>城市：</b>${p.city}<br>
            <b>简介：</b>${p.desc}<br>
            <img src="${p.img}" alt="${p.name}" class="popup-img"/>
          `);
        markerCluster.addLayer(mk);
        bounds.push(p.coords);
      });
      if(bounds.length) map.fitBounds(bounds,{padding:[30,30]});
    }

    renderMarkers();

    // ============== 路线连线（城市顺序） ==============
    const cityOrder = ["淮安","扬州","常州"];
    const routePoints = places.filter(p=>cityOrder.includes(p.city))
      .sort((a,b)=>cityOrder.indexOf(a.city)-cityOrder.indexOf(b.city))
      .map(p=>p.coords);
    L.polyline(routePoints, {color:"#2563eb", weight:3, dashArray:"6,6"}).addTo(map);

    // ============== 控件 ==============
    // 图例
    const legend = L.control({ position:'bottomright' });
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = `
        <div class="row"><span class="dot" style="background:${typeStyles.museum.color}"></span>博物馆/展馆</div>
        <div class="row"><span class="dot" style="background:${typeStyles.bridge.color}"></span>桥梁</div>
        <div class="row"><span class="dot" style="background:${typeStyles.landmark.color}"></span>街区/河段/塔楼</div>
      `;
      return div;
    };
    legend.addTo(map);

    // 缩放按钮
    const fitBtn = L.control({ position:'topleft' });
    fitBtn.onAdd = function(){
      const div = L.DomUtil.create('div','fit-btn');
      div.innerHTML = "缩放至全部点";
      div.onclick = ()=>renderMarkers();
      return div;
    };
    fitBtn.addTo(map);

    // 筛选框（城市+类型）
    const filterBox = L.control({ position:'topleft' });
    filterBox.onAdd = function(){
      const div = L.DomUtil.create('div','filter-box');
      div.innerHTML = `
        城市：
        <select id="cityFilter">
          <option>全部</option>
          <option>淮安</option>
          <option>扬州</option>
          <option>常州</option>
        </select>
        类型：
        <select id="typeFilter">
          <option>全部</option>
          <option value="museum">博物馆/展馆</option>
          <option value="bridge">桥梁</option>
          <option value="landmark">街区/河段/塔楼</option>
        </select>
      `;
      return div;
    };
    filterBox.addTo(map);

    // 筛选事件
    document.addEventListener('change', e=>{
      const city = document.getElementById("cityFilter").value;
      const type = document.getElementById("typeFilter").value;
      renderMarkers(city,type);
    });

  </script>
</body>
</html>
